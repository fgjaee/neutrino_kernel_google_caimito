name: Build Neutrino Kernel

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:
  build:
    name: Build Kernel (Pixel 9 Pro Fold)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Source
      uses: actions/checkout@v4
      with:
        path: kernel_source
        fetch-depth: 1

    - name: Prepare Directory Structure
      run: |
        mkdir -p google-modules

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison flex libssl-dev make libc6-dev libncurses5-dev lz4 openssl python3

    - name: Setup Toolchain
      run: |
        cd kernel_source
        chmod +x setup_toolchain.sh
        ./setup_toolchain.sh

    - name: Build Kernel
      run: |
        cd kernel_source
        chmod +x build_kernel.sh
        ./build_kernel.sh

    # DISABLED: Causing errors and unnecessary if using AnyKernel3
    # - name: Repack Vendor Kernel Boot
    #   run: ...

    - name: Generate AnyKernel3 Zip
      run: |
        cd kernel_source

        echo "â¬‡ï¸ Gathering Build Artifacts..."
        # 1. Copy Kernel Image
        cp out/arch/arm64/boot/Image.lz4 AnyKernel3/

        # 2. Copy DTBs (Try multiple common locations)
        # Standard kernel output location:
        cp out/arch/arm64/boot/dts/google/*.dtb AnyKernel3/dtb 2>/dev/null || true
        cp out/arch/arm64/boot/dts/google/*.dtb AnyKernel3/ 2>/dev/null || true
        # Google Modules output location:
        cp out/google-modules/soc/*.dtb AnyKernel3/dtb 2>/dev/null || true

        # 3. Run the zipper
        echo "ðŸ“¦ Zipping..."
        chmod +x scripts/make_anykernel3_zip.sh
        ./scripts/make_anykernel3_zip.sh

    - name: Upload AnyKernel3 Zip
      uses: actions/upload-artifact@v4
      with:
        name: AnyKernel3-Neutrino-Signed
        path: kernel_source/AnyKernel3/*.zip
